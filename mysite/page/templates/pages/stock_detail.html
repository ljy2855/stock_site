{% extends 'pages/base.html' %}

{% block content %}




<div class="content container">
    <div class="content">




        <h1>{{ stock.name |linebreaksbr }}</h1>
      
        <h3>
            현재가 : {{ stock.price|linebreaksbr }}
        </h3>

        <div class="date">
            <plus>고가 : {{ stock.high_price|linebreaksbr }}<br></plus>
            <minus>저가 : {{ stock.low_price|linebreaksbr }}<br></minus>
            등락 :
            {% if stock.up_down < 0 %} <minus> {{stock.up_down}}% </minus>
                {% else %}
                <plus> +{{stock.up_down}}% </plus>
                {% endif %}<br>
                <b> {{ stock.update_at| date:"Y-m-d H:m" }}</b>
        </div>
        {% if user.is_authenticated %}
        <a class="btn btn-default" href="{% url 'main_page'%}"><span
                class="glyphicon glyphicon-plus"></span></a>

        {% endif %}
        <div id="chartContainer" style="height: 400px; width: 100%;"></div>

    </div>




</div>

<script>
    var ctx = document.getElementById('stockChart').getContext('2d');
    var jsonData = JSON.parse('{{ data|safe }}'); // Django에서 전달된 데이터
    var dates = jsonData.map(data => data.date);
    var closingPrices = jsonData.map(data => data.closing_price);
    var marketPrices = jsonData.map(data => data.market_price);
    var highPrices = jsonData.map(data => data.high_price);
    var lowPrices = jsonData.map(data => data.low_price);
    var amounts = jsonData.map(data => data.amount);
    var transformedData = jsonData.map(item => {
            return {
                t: luxon.DateTime.fromISO(item.date),
                o: parseFloat(item.market_price),
                h: parseFloat(item.high_price),
                l: parseFloat(item.low_price),
                c: parseFloat(item.closing_price)
            };
        });
    console.log(transformedData)
    
    var stockChart = new Chart(ctx, {
            type: 'line', // 라인 차트
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'Closing Price',
                        data: closingPrices,
                        borderColor: 'red',
                        borderWidth: 1
                    },
                    {
                        label: 'Market Price',
                        data: marketPrices,
                        borderColor: 'blue',
                        borderWidth: 1
                    },
                    {
                        label: 'High Price',
                        data: highPrices,
                        borderColor: 'green',
                        borderWidth: 1
                    },
                    {
                        label: 'Low Price',
                        data: lowPrices,
                        borderColor: 'purple',
                        borderWidth: 1
                    },
                    {
                        label: 'Amount',
                        data: amounts,
                        type: 'bar',
                        borderColor: 'orange',
                        yAxisID: 'y-axis-2'
                    }
                ]
            },
            options: {
            scales: {
                yAxes: [{
                    id: 'y-axis-1',
                    type: 'linear',
                    position: 'left',
                    ticks: {
                        max: 200000, // 예시: 이 값을 조정하여 스케일 조정
                        min: 0
                    }
                }, {
                    id: 'y-axis-2',
                    type: 'linear',
                    position: 'right',
                    gridLines: {
                        drawOnChartArea: false
                    },
                }],
                
            }
        }
        });
</script>

<script type="text/javascript">
    
    window.onload = function () {
        var jsonData = JSON.parse('{{ data|safe }}'); // Django에서 전달된 데이터
        
        // var dates = jsonData.map(data => data.date);
        // var closingPrices = jsonData.map(data => data.closing_price);
        // var marketPrices = jsonData.map(data => data.market_price);
        // var highPrices = jsonData.map(data => data.high_price);
        // var lowPrices = jsonData.map(data => data.low_price);
        // var amounts = jsonData.map(data => data.amount);
        var dataPoints1 = [], dataPoints2 = [], dataPoints3 = [];
        var stockChart = new CanvasJS.StockChart("chartContainer", {
            exportEnabled: true,
            theme: "light2",
            title: {
                text: "StockChart"
            },
            charts: [{
                toolTip: {
                    shared: true
                },
                axisX: {
                    lineThickness: 5,
                    tickLength: 0,
                    labelFormatter: function (e) {
                        return "";
                    },
                    crosshair: {
                        enabled: true,
                        snapToDataPoint: true,
                        labelFormatter: function (e) {
                            return ""
                        }
                    }
                },
                axisY2: {
                    title: "Stock Price",
                    prefix: "₩"
                },
                legend: {
                    verticalAlign: "top",
                    horizontalAlign: "left"
                },
                data: [{
                    name: "가격",
                    yValueFormatString: "#,###.##",
                    axisYType: "secondary",
                    type: "candlestick",
                    risingColor: "green",
                    fallingColor: "red",
                    dataPoints: dataPoints1
                }]
            }, {
                height: 100,
                toolTip: {
                    shared: true
                },
                axisX: {
                    crosshair: {
                        enabled: true,
                        snapToDataPoint: true
                    }
                },
                axisY2: {
                    prefix: "",
                    
                },
                legend: {
                    horizontalAlign: "left"
                },
                data: [{
                    yValueFormatString: "#,###.##",
                    axisYType: "secondary",
                    name: "거래량",
                    dataPoints: dataPoints2
                }]
            }],
            navigator: {
                data: [{
                    color: "grey",
                    dataPoints: dataPoints3
                }],
                slider: {
                    minimum: new Date(year=2023, monthIndex=6, date=1),
                    maximum: new Date(),
                }
            }
        });
         function load() {
            var data = jsonData;
            console.log(data);
            for (var i = 0; i < data.length; i++) {
                dataPoints1.push({ x: new Date(data[i].date), y: [Number(data[i].market_price), Number(data[i].high_price), Number(data[i].low_price), Number(data[i].closing_price)], color: data[i].market_price < data[i].closing_price ? "green" : "red" });;
                dataPoints2.push({ x: new Date(data[i].date), y: Number(data[i].amount), color: data[i].market_price < data[i].closing_price ? "green" : "red" });
                dataPoints3.push({ x: new Date(data[i].date), y: Number(data[i].closing_price) });
            }
            console.log(dataPoints1);
            stockChart.render();
        }
        load();
    
    }
</script>
{% endblock %}